<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang quản lý BHYT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h3 class="mb-4">Danh sách BHYT đến hạn</h3>
    <div class="mb-3">
      <button class="btn btn-primary me-2" onclick="loadData('dueSoon')">±30 ngày</button>
      <button class="btn btn-warning me-2" onclick="loadData('expiredRecently')">30–90 ngày trước</button>
      <select id="monthSelect" class="form-select d-inline w-auto" onchange="loadData('byMonth')">
        <option value="">Chọn tháng</option>
      </select>
    </div>
    <div id="loading" class="text-muted mb-2">Đang tải dữ liệu...</div>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Họ tên</th>
            <th>Ngày sinh</th>
            <th>Từ ngày</th>
            <th>Đến ngày</th>
            <th>Số điện thoại</th>
            <th>Địa chỉ</th>
            <th>maPb</th>
            <th>maBv</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
    <button class="btn btn-outline-secondary mt-3" onclick="logout()">Đăng xuất</button>
  </div>

  <script>
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/YOUR_EXEC_URL/exec'
    };

    const user = JSON.parse(localStorage.getItem('bhyt_user') || '{}');

    function logout() {
      localStorage.removeItem('bhyt_user');
      window.location.href = './index.html';
    }

    async function loadData(type) {
      document.getElementById('loading').innerText = 'Đang tải dữ liệu...';
      document.getElementById('dataBody').innerHTML = '';
      if (!user || !user.cccd) return logout();

      const payload = {
        action: 'fetchBHYTData',
        filterType: type,
        userCCCD: user.cccd
      };

      if (type === 'byMonth') {
        const month = document.getElementById('monthSelect').value;
        if (!month) return;
        payload.month = month;
        payload.year = new Date().getFullYear();
      }

      const formBody = Object.entries(payload)
        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');

      try {
        const res = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formBody
        });
        const data = await res.json();
        if (data.success) {
          const rows = data.data.map(row => `
            <tr>
              <td>${row.hoTen}</td>
              <td>${row.ngaySinh}</td>
              <td>${row.hanTheTu}</td>
              <td>${row.hanTheDen}</td>
              <td>${row.soDienThoai}</td>
              <td>${row.diaChiLh}</td>
              <td>${row.maPb}</td>
              <td>${row.maBv}</td>
            </tr>
          `).join('');
          document.getElementById('dataBody').innerHTML = rows || '<tr><td colspan="8">Không có dữ liệu</td></tr>';
        } else {
          document.getElementById('dataBody').innerHTML = `<tr><td colspan="8">${data.error}</td></tr>`;
        }
      } catch (err) {
        document.getElementById('dataBody').innerHTML = `<tr><td colspan="8">Lỗi hệ thống</td></tr>`;
      }

      document.getElementById('loading').innerText = '';
    }

    // Tự động điền các tháng vào select
    window.onload = () => {
      const today = new Date();
      const select = document.getElementById('monthSelect');
      for (let m = 1; m <= 12; m++) {
        const option = document.createElement('option');
        option.value = m;
        option.textContent = `Tháng ${m}/${today.getFullYear()}`;
        select.appendChild(option);
      }
      loadData('dueSoon');
    };
  </script>
</body>
</html>
