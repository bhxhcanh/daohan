
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang quản lý BHYT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Danh sách BHYT đến hạn</h3>
        <span id="userInfo" class="text-muted"></span>
    </div>
    <div class="mb-3">
      <button class="btn btn-primary me-2" onclick="loadData('dueSoon')">±30 ngày</button>
      <button class="btn btn-warning me-2" onclick="loadData('expiredRecently')">30–90 ngày trước</button>
      <select id="monthSelect" class="form-select d-inline w-auto" onchange="loadData('byMonth')">
        <option value="">Chọn tháng</option>
      </select>
    </div>
    <div id="loading" class="text-muted mb-2">Đang tải dữ liệu...</div>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Hạn thẻ đến</th>
            <th>Họ tên</th>
            <th>Giới tính</th>
            <th>Ngày sinh</th>
            <th>Địa chỉ LH</th>
            <th>Mã PB</th>
            <th>Số CMND/CCCD</th>
            <th>Mã BV</th>
            <th>Số điện thoại</th>
            <th>Số KCB</th>
            <th>Mã ĐV</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
    <button class="btn btn-outline-secondary mt-3" onclick="logout()">Đăng xuất</button>
  </div>

  <script src="scripts.js"></script>
  <script>
    const user = JSON.parse(localStorage.getItem('bhyt_user') || '{}');

    // logout() function will be used from scripts.js

    async function loadData(type) {
      document.getElementById('loading').innerText = 'Đang tải dữ liệu...';
      document.getElementById('dataBody').innerHTML = '';
      if (!user || !user.cccd) {
        if (typeof logout === 'function') {
            logout();
        } else {
            console.error('Logout function not available');
            localStorage.removeItem('bhyt_user');
            window.location.href = './index.html';
        }
        return;
      }

      const payload = {
        action: 'fetchBHYTData',
        filterType: type,
        userCCCD: user.cccd
      };

      if (type === 'byMonth') {
        const monthSelect = document.getElementById('monthSelect');
        const selectedValue = monthSelect.value;
        if (!selectedValue) {
            document.getElementById('loading').innerText = ''; 
            // Optionally display a message that a month needs to be selected or clear table
            document.getElementById('dataBody').innerHTML = '<tr><td colspan="11">Vui lòng chọn một tháng để lọc.</td></tr>';
            return;
        }
        // Assuming value is "month/year" e.g., "3/2025"
        const [month, year] = selectedValue.split('/');
        payload.month = month;
        payload.year = year;
      }

      const formBody = Object.entries(payload)
        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');

      try {
        if (typeof CONFIG === 'undefined' || !CONFIG.API_URL) {
            console.error('CONFIG.API_URL is not defined.');
            document.getElementById('dataBody').innerHTML = `<tr><td colspan="11">Lỗi cấu hình: API URL không được định nghĩa.</td></tr>`;
            document.getElementById('loading').innerText = '';
            return;
        }
        const res = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formBody
        });
        const data = await res.json();
        if (data.success) {
          const rows = data.data.map(row => `
            <tr>
              <td>${row.hanTheDen || ''}</td>
              <td>${row.hoTen || ''}</td>
              <td>${row.gioiTinh || ''}</td>
              <td>${row.ngaySinh || ''}</td>
              <td>${row.diaChiLh || ''}</td>
              <td>${row.maPb || ''}</td>
              <td>${row.soCmnd || ''}</td>
              <td>${row.maBv || ''}</td>
              <td>${row.soDienThoai || ''}</td>
              <td>${row.soKcb || ''}</td>
              <td>${row.maDvi || ''}</td>
            </tr>
          `).join('');
          document.getElementById('dataBody').innerHTML = rows || '<tr><td colspan="11">Không có dữ liệu</td></tr>';
        } else {
          document.getElementById('dataBody').innerHTML = `<tr><td colspan="11">${data.error || 'Lỗi không xác định từ máy chủ.'}</td></tr>`;
        }
      } catch (err) {
        console.error('Error fetching BHYT data:', err);
        document.getElementById('dataBody').innerHTML = `<tr><td colspan="11">Lỗi hệ thống khi tải dữ liệu. Vui lòng thử lại.</td></tr>`;
      }
      document.getElementById('loading').innerText = '';
    }

    window.onload = () => {
      if (!user || !user.cccd) {
        if (typeof logout === 'function') {
            logout();
        } else {
            localStorage.removeItem('bhyt_user');
            window.location.href = './index.html';
        }
        return; 
      }

      if (user.fullName) {
        document.getElementById('userInfo').textContent = `Xin chào, ${user.fullName}`;
      }


      const today = new Date();
      const currentYear = today.getFullYear();
      const select = document.getElementById('monthSelect');
      // Populate for current year and next year
      for (let yOffset = 0; yOffset <= 1; yOffset++) {
          const yearToDisplay = currentYear + yOffset;
          for (let m = 1; m <= 12; m++) {
            const option = document.createElement('option');
            option.value = `${m}/${yearToDisplay}`; // Store as "month/year"
            option.textContent = `Tháng ${m}/${yearToDisplay}`;
            select.appendChild(option);
          }
      }
      loadData('dueSoon'); // Initial data load
    };
  </script>
</body>
</html>
